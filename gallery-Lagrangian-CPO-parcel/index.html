<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Lagrangian CPO parcel - specfab documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Lagrangian CPO parcel";
        var mkdocs_page_input_path = "gallery-Lagrangian-CPO-parcel.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> specfab documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">üìñ About</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../install/">üì¶ Install</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">üíé CPO representation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../cpo-representation/">Representation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cpo-structuretensors/">Structure tensors</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cpo-statespace/">State space</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">‚öôÔ∏è CPO Dynamics</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../fabdyn-matrix-model/">Matrix model</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../fabdyn-LROT/">Lattice rotation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../fabdyn-DDRX/">Discontinous DRX</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../fabdyn-CDRX/">Continous DRX</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../fabdyn-REG/">Regularization</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">üåÄ Viscosity</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../enhancements-strainrate/">Strain-rate enhancement</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../enhancements-strainrate-ice/">Glacier ice</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../enhancements-strainrate-olivine/">Olivine</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">üåä Wave propagation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../waveprop-elastic/">Elastic</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../waveprop-electromagnetic/">Electromagnetic</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">üñºÔ∏è Application Gallery</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Lagrangian CPO parcel</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#constant-thermomechanical-conditions">Constant thermomechanical conditions</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#ice-divide">Ice divide</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#code-example">üìù Code example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#ssa-column">SSA column</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../gallery-Eulerian-CPO-field/">Eulerian CPO field</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../gallery-CPO-from-radar/">Inferring CPO from radar</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../gallery-CPO-flow-coupling/">Coupling CPO and flow</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">üß© Miscellaneous</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../deformation-kinematics/">Deformation kinematics</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cpo-plot/">Plot CPO</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cpo-rotation/">Rotate CPO</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../constitutive-viscoplastic/">Viscoplastic constitutive eqns.</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../constitutive-elastic/">Elastic constitutive eqns.</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">specfab documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>üñºÔ∏è Application Gallery &raquo;</li>
      <li>Lagrangian CPO parcel</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="lagrangian-cpo-parcel">Lagrangian CPO parcel</h1>
<p><img alt="" src="https://raw.githubusercontent.com/nicholasmr/specfab/main/images/modes-strain/lagrangian-parcel-trajectory.png#center" style="width:380px" /> </p>
<p>A Lagrangian parcel refers to a small, moving material volume that is followed through time as it flows within e.g. a glacier or ice sheet, unlike the <a href="../gallery-Eulerian-CPO-field/">Eulerian perspective</a> which focuses on fixed locations in space. 
A Lagrangian description is well-suited for studying CPO evolution along a flow line <span class="arithmatex">\({\bf x}(t)\)</span> if the thermomechanical background conditions are (approximately) steady; that is, the velocity, temperature, and stress fields are constant in time, <em>though not necessarily in space</em>.
By treating each parcel as a discrete entity with its own microstructural state that updates with time, a Lagrangian parcel model is a particularly simply way to estimate CPO evolution and to calculate CPO-induced quantities along a flow line, such as mechanical or dielectric anisotropy. </p>
<p>Below, some examples are given on how to model CPO evolution of a Lagrangian parcel relevant to glacier ice.</p>
<hr />
<h2 id="constant-thermomechanical-conditions">Constant thermomechanical conditions</h2>
<p><em>Specfab</em> includes a high-level integrator for calculating the CPO evolution of a Lagrangian parcel subject to a spatio-temporally constant strain-rate, stress and temperature.
The following code illustrates how to use it, which relies on specifying the kinematic mode of deformation in terms of the <code>DK</code> object.</p>
<pre><code class="language-python">import numpy as np
from specfabpy import specfab as sf
from specfabpy import integrator as sfint

L = 12 # expansion series truncation
lm, nlm_len = sf.init(L) 

Nt = 200 # number of integration time steps taken
nlm = np.zeros((Nt+1,nlm_len), dtype=np.complex64) # expansion coefficients

### Pure shear

axis = 2     # axis of compression (0,1,2 = x,y,z)
tau  = 1     # characteristic e-folding deformation time
q    = +0.25 # asymmetry in directions of extension: q=0 =&gt; unconfined, q=+1 or q=-1 =&gt; 100% confinement in either of the extending directions
strain_target = -0.95 # deform parcel until this strain target is reached along &quot;axis&quot;

DK = dict(type='ps', q=q, axis=axis, tau=tau) # deformation kinematics

### Simple shear

#plane = 1 # (0,1,2 = yz,xz,xy shear)
#strain_target = np.deg2rad(75) # deform parcel until this target strain (strain angle)
#tau = 1 # characteristic deformation time-scale (1/shearrate)

#DK = dict(type='ss', plane=plane, tau=tau)

### Integrate

kw_dyn = dict(
    iota   = 1,    # plastic spin strength (default: iota=1 for deck-of-cards behaviour)
    nu     = 1,    # multiplicative factor for default regularization strength (default: nu=1)
    Gamma0 = None, # DDRX magnitude (None = disabled), assumes stress is coaxial to strain rate
    Lambda = None, # CDRX magnitude (None = disabled)
)

nlm[:,:], Fi, ti, ugrad = sfint.lagrangianparcel(sf, DK, strain_target, Nt=Nt, **kw_dyn)

&quot;&quot;&quot;
Outputs are:
------------
nlm (Nt,nlm_len): Harmonic coefficients at each time step
Fi (Nt,3,3):      Deformation gradient tensor at each time step
ti (Nt):          Total time at each time step 
ugrad (3,3):      Velocity gradient
&quot;&quot;&quot;

### Auxiliary

strain = np.array([sf.F_to_strain(Fi[nn]) for nn in np.arange(Nt)]) # strain tensor
</code></pre>
<hr />
<h2 id="ice-divide">Ice divide</h2>
<div style="float: left; width: 60%;">
<p>A Lagrangian approach is well-suited for modelling the vertical CPO profile at ice sheet domes and divides. 
Assuming e.g. the classical Nye model of an ice divide of height <span class="arithmatex">\(H\)</span> (no basal melt, constant rate of thinning, a constant accumulation rate <span class="arithmatex">\(a\)</span>), the <a href="../deformation-kinematics/">velocity gradient</a> is constant and equal to </p>
<div class="arithmatex">\[
\nabla {\bf u} = 
-\frac{1}{\tau}
\begin{bmatrix}
-(1+q)/2 &amp; 0 &amp; 0\\
0 &amp; -(1-q)/2 &amp; 0\\
0&amp; 0&amp; 1
\end{bmatrix}
,
\]</div>
<p>where <span class="arithmatex">\(q=0\)</span> for a axis-symmetric dome and <span class="arithmatex">\(q=\pm 1\)</span> for a divide aligned with the <span class="arithmatex">\(x\)</span> or <span class="arithmatex">\(y\)</span> direction. 
The <span class="arithmatex">\(e\)</span>-folding time <span class="arithmatex">\(\tau\)</span> is a function of the ice-equivalent accumulation rate and divide thickness: </p>
<div class="arithmatex">\[    
\tau = \frac{a}{H}.
\]</div>
<p>Depending on whether temperatures are large enough to <a href="../fabdyn-DDRX/">activate DDRX</a> or not, the temperature profile must be prescribed, too. </p>
</div>
<div style="float: right;width: 2%;"></div>
<div style="float: right;width: 38%;">
<p><img alt="" src="https://raw.githubusercontent.com/nicholasmr/specfab/main/images/deformation/divide-parcel.png" style="width:300px" /> </p>
</div>
<div style="clear: both;"></div>
<h3 id="code-example">üìù Code example</h3>
<p>The below example shows how to model the CPO profile of the GRIP ice core, Greenland. 
Eigenvalues of other ice cores can be <a href="https://github.com/nicholasmr/specfab/tree/main/data/icecores">found here</a>.</p>
<pre><code class="language-python">&quot;&quot;&quot;
Modeled CPO profile of the GRIP ice core, Greenland
&quot;&quot;&quot;

import numpy as np
from scipy import interpolate
import pandas as pd

import matplotlib.pyplot as plt

from matplotlib import rc
#rc('font',**{'family':'sans-serif','sans-serif':['Helvetica']})
rc('font',**{'family':'serif','serif':['Palatino']})
rc('text', usetex=True)

from specfabpy import specfab as sf
from specfabpy import common as sfcom
from specfabpy import plotting as sfplt

### Init

L = 12 # expansion series truncation
lm, nlm_len = sf.init(L)

### Velocity gradient experienced by parcel 

H = 3027 # ice thickness (Montagnat et al., 2014)
a = 0.24 # meter ice equiv. per yr (Montagnat et al., 2014)

tau = H/a # e-folding time scale
ugrad = -1/tau * np.diag([-0.5, -0.5, 1]) # uniaxial compression along z-axis
D = (ugrad+np.transpose(ugrad))/2 # symmetric part (strain rate tensor)
W = (ugrad-np.transpose(ugrad))/2 # anti-symmetric part (spin tensor)
S = D # stress tensor (assume coaxiality with strain-rate tensor; magnitude does not matter for our purpose)

### Fabric dynamics

# Lattice rotation
iota, zeta = 1, 0 # &quot;deck of cards&quot; behavior 

# DDRX
A = 1.1e7 # rate prefactor (tunable parameter)
Q = 3.36e4 # activation energy (see Richards et al. (2021) and Lilien et al. (2023))
R = 8.314  # gas constant
Gamma0 = lambda D, T: A*np.sqrt(np.einsum('ij,ji',D,D)/2)*np.exp(-Q/(R*(T+273.15))) # DDRX rate factor

### Numerics 

Nt = 500 # number of time steps
dt = 100 # time step size (yr)
ti = np.arange(0,Nt) * dt # time vector
zi = np.exp(-ti/tau) # relative height above bed at each point in time

### Temperature profile 

df = pd.read_csv('../../../data/icecores/GRIP/temperature.csv') # fetch from github
f = interpolate.interp1d(df['zrel'].to_numpy(), df['T'].to_numpy(), kind='nearest', fill_value='extrapolate')
Ti = f(zi) # temperature vector
#Ti[:] = -60 # no DDRX if very cold

### Initial fabric state

nlm  = np.zeros((Nt,nlm_len), dtype=np.complex64) # state vector
lami = np.zeros((Nt,3)) # a2 eigenvalues

lxy = 0.25 # initial horizontal eigenvalues
a2_0 = np.diag([lxy, lxy, 1-2*lxy]) # initial a2 surface state
nlm[0,:sf.L2len] = sf.a2_to_nlm(a2_0) # initial state vector
lami[0] = sfcom.eigenframe(nlm[0])[1] # eigenvalues of initial state

### Euler integration

for tt in np.arange(1,Nt):
    nlm_0 = nlm[tt-1,:] # previous solution
    T = Ti[tt] # temperature from borehole measurements
    M_LROT = sf.M_LROT(nlm_0, D, W, iota, zeta) # lattice rotation operator
    M_DDRX = Gamma0(D,T)*sf.M_DDRX(nlm_0, S)    # DDRX operator
    M_REG  = sf.M_REG(nlm_0, D)                 # regularization operator
    M      = M_LROT + M_DDRX + M_REG
    nlm[tt]  = nlm_0 + dt*np.matmul(M, nlm_0) # Euler step
    lami[tt] = sfcom.eigenframe(nlm[tt])[1]

### Plot modeled eigenvalues

fig = plt.figure(figsize=(3,4))
ax = plt.subplot(111)

c1,c2,c3 = 'tab:green', 'tab:red', 'k'

ax.plot(lami[:,0], zi, '-',  c=c1, label=r'$\lambda_1$')
ax.plot(lami[:,1], zi, '-',  c=c2, label=r'$\lambda_2$')
ax.plot(lami[:,2], zi, '--', c=c3, label=r'$\lambda_3$')

ax.legend(loc=1, fancybox=False, frameon=False)
ax.set_title(r'GRIP ice core')

ax.set_xlabel(r'$\lambda_i$')
ax.set_xticks(np.arange(0,1+.01,0.2))
ax.set_xlim([0,1])

ax.set_ylabel(r'$z/H$')
ax.set_yticks(np.arange(0,1+.01,0.1))
ax.set_ylim([0,1])

### Plot modeled CPOs

geo, prj = sfplt.getprojection(rotation=45, inclination=50)

def plotCPO(ax, nlm, p0, HW=0.2, cmap='Greys'):
    axtrans = ax.transData.transform(p0)
    trans = fig.transFigure.inverted().transform(axtrans)
    axin = plt.axes([trans[0]-HW/2, trans[1]-HW/2, HW,HW], projection=prj)
    axin.set_global()
    lvlset = [np.linspace(0.05, 0.45, 8), lambda x,p:'%.1f'%x]
    sfplt.plotODF(nlm, lm, axin, lvlset=lvlset, cmap=cmap, showcb=False, nchunk=None)
    sfplt.plotcoordaxes(axin, geo, negaxes=False, color=sfplt.c_dred, axislabels='xi')
    return axin

for _ in np.linspace(0.1, 0.9, 4):
    I = np.argmin(np.abs(zi-_))
    plotCPO(ax, nlm[I], (1.2,_))

### Plot observations 

df = pd.read_csv('../../../data/icecores/GRIP/orientations.csv') # fetch from github
zi = df['zrel'].to_numpy()

kw = dict(marker='o', facecolor='none', zorder=1)
ax.scatter(df['lam1'].to_numpy(), zi, edgecolor=c1, **kw)
ax.scatter(df['lam2'].to_numpy(), zi, edgecolor=c2, **kw)
ax.scatter(df['lam3'].to_numpy(), zi, edgecolor=c3, **kw)

### Save plot

plt.savefig('GRIP.png', dpi=175, pad_inches=0.1, bbox_inches='tight')
</code></pre>
<p>The below figure shows the model result (lines) compared to observations (markers) from thin sections made on the GRIP ice core. </p>
<p><img alt="" src="https://raw.githubusercontent.com/nicholasmr/specfab/main/docs/snippets/Lagrangian-CPO-parcel/GRIP.png#center" style="width:400px" /> </p>
<hr />
<h2 id="ssa-column">SSA column</h2>
<p><img alt="" src="https://raw.githubusercontent.com/nicholasmr/specfab/main/images/SSA-fabric/lagrangian-column-trajectory.png#center" style="width:500px" /> </p>
<p>If the Shallow Shelf/Stream Approximation (SSA) is applicable, velocities can be assumed depth constant (no vertical shearing). 
In this case, a <a href="../gallery-Eulerian-CPO-field/">depth-average treatment of CPO evolution</a> transforms the Lagrangian parcel model into a Lagrangian <em>column</em> model. 
This generalizes the above parcel model, since the velocity gradient, stress and temperature fields can no longer be assumed constant but depend on the column position <span class="arithmatex">\({\bf x}(t)=[x(t),y(t)]\)</span>.</p>
<p>üöß <em>Documentation not finished.</em></p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../waveprop-electromagnetic/" class="btn btn-neutral float-left" title="Electromagnetic"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../gallery-Eulerian-CPO-field/" class="btn btn-neutral float-right" title="Eulerian CPO field">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../waveprop-electromagnetic/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../gallery-Eulerian-CPO-field/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
